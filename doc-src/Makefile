# File: Makefile

ROOT=..

PANDOC=pandoc
OPTS=	-s --smart \
	--toc-depth=5 \
	--chapters \
	--atx-headers \
	--latex-engine=xelatex \
	-V documentclass=book \
        -V geometry:margin=1in \
	-V fontsize=10
DOCSRC=$(shell grep -v '\#' 00-files.txt)
FILTER=$(ROOT)/tool/depNonNullFilter

BUILD_DIR=$(ROOT)/build
DOC_TMP=$(BUILD_DIR)/doc
TARGET=$(ROOT)/doc
DEP_NN=dep-non-null

PANDOC_PIPE_HD=$(PANDOC) -f markdown $(OPTS) $(DOCSRC) -t json | $(FILTER)
PANDOC_TL=$(PANDOC) $(OPTS) -f json
PANDOC_PIPE=$(PANDOC_PIPE_HD) | $(PANDOC_TL)

FIX_MATH_SUP=perl -pi -e 's%\^([^\{])|\^\{([^\{]+)\}%<sup>\1\2</sup>%g'

#-------------------------------------------------------------------------------

.PHONY:	default prep json latex md pdf

default: prep json latex md pdf

#-------------------------------------------------------------------------------
# PDF

pdf: prep
	$(PANDOC_PIPE) --toc -H 00-latex.tex -o $(TARGET)/$(DEP_NN).pdf

#-------------------------------------------------------------------------------
# Intermediate formats

latex: prep
	$(PANDOC_PIPE) --toc -t latex -H 00-latex.tex -o $(DOC_TMP)/$(DEP_NN).tex

json: prep
	$(PANDOC_PIPE_HD) | python -m json.tool > $(DOC_TMP)/$(DEP_NN).json

#-------------------------------------------------------------------------------

prep: $(BUILD_DIR) $(DOC_TMP)

$(DOC_TMP):
	-mkdir $(DOC_TMP)

$(BUILD_DIR):
	-mkdir $(BUILD_DIR)

#-------------------------------------------------------------------------------
# Consolidated .md file:

.PHONY:	mdgen mdcp

md: prep mdgen mdcp

mdgen: $(DOC_TMP)/01-front-matter.md $(DOC_TMP)/toc.md
	$(PANDOC_PIPE_HD) --md | $(PANDOC_TL) \
		-H $(DOC_TMP)/01-front-matter.md \
		-H $(DOC_TMP)/toc.md \
		-t markdown_github -o $(DOC_TMP)/$(DEP_NN).md
	$(FIX_MATH_SUP) $(DOC_TMP)/$(DEP_NN).md

mdcp:
	-cp $(DOC_TMP)/$(DEP_NN).md $(TARGET)/$(DEP_NN)-AUTOGENERATED-DO-NOT-EDIT.md

$(DOC_TMP)/01-front-matter.md: 01-front-matter.md
	sed -n '1{s/^%/#/;p;q;}' 01-front-matter.md > $(DOC_TMP)/01-front-matter.md
	sed -n '2{s/^%/###/;p;q;}' 01-front-matter.md >> $(DOC_TMP)/01-front-matter.md
	sed -n '3{s/^%/####/;p;q;}' 01-front-matter.md >> $(DOC_TMP)/01-front-matter.md

$(DOC_TMP)/toc.md: $(DOC_TMP)/$(DEP_NN)-from-html.md
	tail +5 $(DOC_TMP)/$(DEP_NN)-from-html.md \
		| grep -B999 -m1 -e "^$$" > $(DOC_TMP)/toc.md

$(DOC_TMP)/$(DEP_NN)-from-html.md: $(DOC_TMP)/$(DEP_NN).html
	pandoc -f html -s --atx-headers $(DOC_TMP)/$(DEP_NN).html \
		-t markdown_github -o $(DOC_TMP)/$(DEP_NN)-from-html.md

$(DOC_TMP)/$(DEP_NN).html: prep
	$(PANDOC_PIPE) --toc -t html -o $(DOC_TMP)/$(DEP_NN).html

#-------------------------------------------------------------------------------
