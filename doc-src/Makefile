# File: Makefile

ROOT=..

PANDOC=pandoc -f markdown
OPTS=	-s --toc --smart \
	--toc-depth=5 \
	--chapters \
	--atx-headers \
	--latex-engine=xelatex \
	-V documentclass=book \
        -V geometry:margin=1in \
	-V fontsize=10
DOCSRC=$(shell grep -v '\#' 00-files.txt)
FILTER=$(ROOT)/tool/depNonNullFilter

BUILD_DIR=$(ROOT)/build
DOC_TMP=$(BUILD_DIR)/doc
TARGET=$(ROOT)/doc
DEP_NN=dep-non-null

PANDOC_PIPE_HD=$(PANDOC) $(OPTS) $(DOCSRC) -t json | $(FILTER)
PANDOC_PIPE=$(PANDOC_PIPE_HD) | $(PANDOC) $(OPTS) -f json

#-------------------------------------------------------------------------------

.PHONY:	default prep json latex md pdf

default: prep json latex md pdf

#-------------------------------------------------------------------------------
# PDF

pdf: prep
	$(PANDOC_PIPE) -H 00-latex.tex -o $(TARGET)/$(DEP_NN).pdf

#-------------------------------------------------------------------------------
# Intermediate formats

latex: prep
	$(PANDOC_PIPE) -t latex -H 00-latex.tex -o $(DOC_TMP)/$(DEP_NN).tex

json: prep
	$(PANDOC_PIPE_HD) | python -m json.tool > $(DOC_TMP)/$(DEP_NN).json

#-------------------------------------------------------------------------------

prep: $(BUILD_DIR) $(DOC_TMP)

$(DOC_TMP):
	-mkdir $(DOC_TMP)

$(BUILD_DIR):
	-mkdir $(BUILD_DIR)

#-------------------------------------------------------------------------------
# Consolidated .md file: (not currently used)

.PHONY:	mdgen mdcp

DOCSRC_MD=$(shell grep -v '\#' 00-files.txt | grep -v front)

md: prep mdgen mdcp

mdgen:
	$(PANDOC) $(OPTS) $(DOCSRC_MD) -t json | $(FILTER) \
		| $(PANDOC) $(OPTS) -f json \
			-H 01-front-matter.md \
			-H 02-contents.md \
			-t markdown_github -o $(DOC_TMP)/$(DEP_NN).md

mdcp:
	-cp $(DOC_TMP)/$(DEP_NN).md $(TARGET)/$(DEP_NN)-DO-NOT-EDIT-AUTOGENERATED.md

#-------------------------------------------------------------------------------
